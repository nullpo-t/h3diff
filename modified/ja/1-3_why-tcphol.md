## TCP head-of-line ブロッキング

HTTP/2は、以前のHTTPよりも少ないTCPコネクション数で通信を行うことができます。
TCPは高信頼性の転送のためのプロトコルで、2台のマシンを「鎖」でつないだものと考えることができます。
一方からネットワーク上に送信されたデータは、最終的に他方に同じ順番で到達するか、もしくはコネクションが切断されて転送失敗になります。

![マシン間におけるTCPの鎖](../images/tcp-chain.png){height=2.2cm}

HTTP/2を使うことで、典型的なブラウザは単一のTCPコネクション上で数十から数百の並列したデータ転送を行うことができます。
HTTP/2で通信している端末間のネットワーク上で1個のパケットが失われることは、そのパケットが再送され宛先に到達するまでの間、TCPコネクション全体が停止することを意味します。
TCPが鎖であるため、つながりの1個が突然失われると、それ以降のすべてのつながりが待機することになります。
2個の異なるストリームを単一のコネクションで送信する場面を鎖のイメージで示します。
これがTCPのhead-of-lineブロッキングです！

![単一コネクションによる複数ストリームの転送](../images/tcp-chain-streams.png){height=2.2cm}

パケットの損失率が上がるにつれ、HTTP/2のパフォーマンスはますます低下します。
2%のパケット損失[^1-3_1]があるネットワークにおいて、HTTP/1のほうが一般的に高性能になることがテストにより判明しています。
これは、HTTP/1が使用する6個までのTCPコネクションがパケットの損失を分散させるからです（あるコネクションでパケットが損失しても、他のコネクションは止まりません）。
TCPを使用する限り、この問題の解決は簡単ではありません。

[^1-3_1]: 念のためですが、これはかなりひどいです

### 独立したストリームによるブロッキングの回避

端末間での接続の安全性とデータ転送の信頼性を確保するために、QUICにおいてもコネクションは依然として存在します。

\newpage

![マシン間におけるQUICの鎖](../images/tcp-chain.png){height=2.2cm}

このコネクション上で2個の異なるストリームが転送を行う際、それらは独立したものとして扱われるため、あるストリームでつながりが損失しても、そのストリームのみ（つまり、その鎖のみ）が停止と再送を行います。
端末間で2個の異なるストリームが転送を行う場面を鎖のイメージで示します。

![マシン間における2個のQUICストリーム](../images/quic-chain-streams.png){height=2.2cm}
